<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8">
  <title>VK API</title>
  <script src="https://vk.com/js/api/openapi.js?169" type="text/javascript"></script>
  <script src="https://code.jquery.com/jquery-2.2.3.min.js"></script>
  <script src="https://gorereper-d0f8.restdb.io/assets/js/eventsource.min.js"></script>
  <script src="https://gorereper-d0f8.restdb.io/rest/_jsapi.js"></script>

  <link rel="stylesheet" href="style.css">
</head>
<body>
  <button type="button" class="sign">Sign In</button>
  <h1>СМЕШНЫЕ КАРТИНКИ =)</h1>
  <div class="center">
    <div class="content">
      <img src="" alt="photo" class="image">
      <p class="phrase">четыре слова...</p>
    </div>
    <div class="panel_page">
      <button type="button" id="next">Next</button>
      <input type="number" id="numOfImage" value="0" min="0">
      <button type="button" id="previous">Previous</button>
    </div>
  </div>
  <ul class="rate_panel">
    <li> <button type="button" id="1" class="rating">1</button></li>
    <li> <button type="button" id="2" class="rating">2</button></li>
    <li> <button type="button" id="3" class="rating">3</button></li>
    <li> <button type="button" id="4" class="rating">4</button></li>
    <li> <button type="button" id="5" class="rating">5</button></li>
  </ul>
  <div class="panel_rand">
    <p>random?<input type="checkbox" id="rand"></p>
  </div>


  <script type="text/javascript">
  VK.init({
    apiId: 8221134
  });
  const sign = document.querySelector(".sign");
  const test = document.getElementById("test");

  const image = document.querySelector(".image");
  const phrase = document.querySelector(".phrase");

  const next = document.getElementById("next");
  const previous = document.getElementById("previous");
  const numOfImage = document.getElementById("numOfImage");

  const rate1 = document.getElementById("1");
  const rate2 = document.getElementById("2");
  const rate3 = document.getElementById("3");
  const rate4 = document.getElementById("4");
  const rate5 = document.getElementById("5");

  const rand = document.getElementById("rand");
  randValue = false;

  const ownerImage = 514918087;
  const album = 284198610;
  const first_idImage = 457239127;

  const ownerPhrase= -37245324;
  const first_idPhrase= 124;

  max_num=10;

  num = 0;
  z=0;

  db = new restdb("62e01cf31894fe7edea718a6");
  your_num = 0;
  your_id = 0;
  database_id = "";
  function auth(){
    VK.Auth.login(function(data){
      if (data.status=="connected") {
        your_id= data.session["user"]["id"];
        console.log(your_id);
        checkAccount();
      }
    });
  }
  function checkAccount(){
    your_acc = new db.account({"vk_id":your_id, "photo_count":0});
    your_acc.save(function(error, res){
    });
    db.account.find({"vk_id":your_id},function(err, res){
          database_id = res[0]["_id"];
          your_num = res[0]["photo_count"];
          num = your_num;
        });
        numTake();
        localStorage.setItem("vk_id",your_id);
        localStorage.setItem("database_id", database_id);
  }

  function numTake(){
    VK.Api.call('photos.get', {owner_id:ownerImage,album_id:album,rev:1,count:1,v:'5.131'}, function(data) {
      max_num = data.response['items'][0]['id']-first_idImage;
      numOfImage.max = max_num;
    });
  }

  function loginStatus(){
    VK.Auth.getLoginStatus( function(data) {
      if (data.status == "connected") {
        your_id = parseInt(localStorage.getItem("vk_id"));
        database_id = localStorage.getItem("database_id");
        numTake();
        console.log(your_id);
        console.log(database_id);
        //убрать авторизация
      }
    });
  }

  function phraseTake(num,error = false){
    if (error) {
      phrase.textContent = "No ID? ;-;";
    }
    else {
      this_idPhrase = first_idPhrase + num;
      VK.Api.call('wall.getById', {posts:ownerPhrase+'_'+this_idPhrase,v:'5.131'}, function(data) {
        try {
          console.log(data);
          if(!data.response[0]['is_deleted'] && data.response[0]['text']!='') {
            phrase.textContent = data.response[0]['text'];
          }
          else if(z==0){
            phraseTake(num+300+z);
            z=100;
          }
          else {
            phraseTake(num+z);
          }
        }
        catch (e) {
          if(e instanceof TypeError && !data.error){
            if(z==0){
              phraseTake(num+300+z);
              z=100;
            }
            else {
              phraseTake(num+z);
            }
          }
        }
      });
    }
  }
  function imageTake(){
    this_idImage = first_idImage + num;
    VK.Api.call('photos.getById', {photos:ownerImage+'_'+this_idImage,v:'5.131'}, function(data) {
      if(!data.error) {
        let height = 0;
        let n = 0;
        let size = data.response[0]['sizes'];
        for (let i = 0; i < size.length; i++) {
          if(size[i]['height']>height){
            height= size[i]['height'];
            n = i;
          }
        }
        image.src = size[n]['url'];
        z=0;
        phraseTake(num);
      }
      else if(data.error['error_code']==200) {
        image.src = "/img/error.jpg";
        phraseTake(num,true);
      }
    });
  }

  loginStatus();
  //access_token=194e5aa7194e5aa7194e5aa7c819332b691194e194e5aa77b9a1f6e0505b26b23ec71f8";



  function addRating(rate){
    db.photos.find({"id":num},function(err, res){
      if (!err) {
        res[0]["count"]++;
        res[0]["photo_count"]+=rate;
        res[0].save(function(error, res){});
      }
      else {
        console.log(err);
      }
      });
  }

  rate1.addEventListener("click", () => {
    addRating(1);
  });
  rate2.addEventListener("click", () => {
    addRating(2);
  });
  rate3.addEventListener("click", () => {
    addRating(3);
  });
  rate4.addEventListener("click", () => {
    addRating(4);
  });
  rate5.addEventListener("click", () => {
    addRating(5);
  });

  sign.addEventListener("click", () => {
    auth();
  });

  next.addEventListener("click", () => {
    if (randValue) {
      num = Math.floor(Math.random() * max_num);
    }else if(num<max_num){
      num = num+1;
    }else if(num==max_num){
      num = 0;
    }
    if (num>your_num){
      your_num;
      db.account.getById(database_id, function(err, res){
      if (!err){
          res["photo_count"]=num;
          res["vk_id"]=num;
          res.save(function(err, res){
            if (!err){
        console.log(res);
        }
    });
    }
  });
}
    imageTake();
    numOfImage.value = num;

  });
  numOfImage.addEventListener("change", () => {
    if (parseInt(numOfImage.value)>max_num) {
      num  = max_num;
    }
    else if(parseInt(numOfImage.value)<0){
      num  = 0;
    }
    else {
      num  = parseInt(numOfImage.value);
    }
    imageTake();
    numOfImage.value = num;
  });
  previous.addEventListener("click", () => {
    if (randValue) {
      num = Math.floor(Math.random() * max_num);
    }else if(num>0){
      num = num-1;
    }
    else if(num==0){
      num= max_num;
    }
    imageTake();
    numOfImage.value = num;
  });
  rand.addEventListener("change", () => {
    randValue = !randValue;
  });


</script>
</body>
</html>
